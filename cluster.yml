---
- name: bootstrap k8s cluster
  hosts: cluster
  gather_facts: true
  vars:
    gitsite: "git@github.com:"
    gitpath: "{{ lookup('env', 'HOME') }}/git/"
    guest_management_network: 192.168.122
  tasks:
    - name: update hostname to be in sync with the inventory host name
      hostname: name={{ inventory_hostname_short }}
      become: true

    - name: update files under /etc
      template:
        src: "templates/etc/{{ item }}.j2"
        dest: "/etc/{{ item }}"
        mode: 0644
        owner: root
        group: root
      with_items:
        - hosts
        - systemd/network/bond0.netdev
        - systemd/network/bond0.network
        - systemd/network/ens4.network
        - systemd/network/ens5.network
      become: true

    - name: install package(s)
      pacman:
        state: present
        update_cache: true
        name:
          - go
          - make
          - docker
          - rng-tools
      become: true

    - name: add user to the docker group
      user:
        name: "{{ lookup('env', 'USER') }}"
        append: true
        groups: docker
      become: true

    - name: enable/start services
      systemd: name={{ item }} enabled=true status=started
      with_items:
        - systemd-networkd
        - systemd-resolved
        - sshd
        - rngd
        - docker
      become: true

    - name: allow the insecure air.local local docker registry access
      lineinfile:
        path: /etc/systemd/system/multi-user.target.wants/docker.service
        regexp: "^ExecStart"
        line: "ExecStart=/usr/bin/dockerd --insecure-registry air.local:5000 -H fd:// $DOCKER_OPTS"
      become: true

    - name: restart docker service
      systemd: name={{ item }} enabled=true status=restarted
      with_items:
        - docker
      become: true

    - name: create git root directory
      file: path={{ gitpath }} state=directory mode=0700

    - name: install the latest golang
      import_tasks: tasks/golang.yml

- name: bootstrap kubernetes master
  import_playbook: master.yml

- name: bootstrap kubernetes node
  import_playbook: node.yml

- name: bootstrap kubernetes network
  import_playbook: network.yml
  when: not travis_ci|bool
