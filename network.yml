---
- name: provision the cluster networking
  hosts: host
  vars:
    ci: false
    networking: flannel
    manifest:
      flannel: https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
      calico:  https://docs.projectcalico.org/v3.2/getting-started/kubernetes/installation/hosted/kubeadm/calico.yaml
      weave: https://git.io/weave-kube
  gather_facts: false
  tasks:
    - name: delete the old networking module
      command: "kubectl delete --force=true -f {{ item.manifest }}"
      when: item.name != networking
      failed_when: false
      with_items:
        - { name: flannel, manifest: "{{ manifest.flannel }}" }
        - { name: calico,  manifest: "{{ manifest.calico }}" }
        - { name: weave,   manifest: "{{ manifest.weave }}" }
      changed_when: false
      when: not ci|bool

    - name: apply the new networking module
      command: "kubectl apply --force=true -f {{ item.manifest }}"
      when: item.name == networking
      with_items:
        - { name: flannel, manifest: "{{ manifest.flannel }}" }
        - { name: calico,  manifest: "{{ manifest.calico }}" }
        - { name: weave,   manifest: "{{ manifest.weave }}" }
      changed_when: false
      when: not ci|bool
